<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Raffle</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #020817 0%, #131C2F 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #1a1a1a;
            overflow-x: hidden;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 48px;
            width: 100%;
            max-width: 520px;
            box-shadow: 0 32px 64px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: translateY(0);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            z-index: 10;
        }

        .container:hover {
            transform: translateY(-8px);
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.16);
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #020817, #131C2F);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            line-height: 1.2;
        }

        .subtitle {
            text-align: center;
            color: #64748b;
            font-size: 1.1rem;
            margin-bottom: 40px;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 32px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 12px;
            color: #334155;
            font-size: 1rem;
            letter-spacing: -0.01em;
        }

        .input-container {
            position: relative;
            display: inline-block;
            width: 100%;
            max-width: 180px;
        }

        input[type="number"] {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: 600;
            background: #ffffff;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            color: #1e293b;
            text-align: center;
        }

        input[type="number"]:focus {
            border-color: #020817;
            outline: none;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: #fefefe;
        }

        input[type="number"]:hover {
            border-color: #cbd5e1;
            background: #fefefe;
        }

        .select-button {
            width: 100%;
            padding: 18px 32px;
            background: linear-gradient(135deg, #020817 0%, #131C2F 100%);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
            letter-spacing: 0.025em;
            text-transform: uppercase;
            margin-top: 8px;
        }

        .select-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .select-button:hover::before {
            left: 100%;
        }

        .select-button:hover {
            background: linear-gradient(135deg, #020817 0%, #131C2F 100%);
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
        }

        .select-button:active {
            transform: translateY(0);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.2);
        }

        .select-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        #result {
            margin-top: 32px;
            display: none;
        }

        /* DRAMATIC LOADING OVERLAY */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #000000 0%, #020817 50%, #131C2F 100%);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            overflow: hidden;
        }

        .loading-overlay.active {
            display: flex;
            animation: fadeInOverlay 0.8s ease-out;
        }

        .loading-overlay.fade-out {
            animation: fadeOutOverlay 1s ease-in forwards;
        }

        @keyframes fadeInOverlay {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOutOverlay {
            to { opacity: 0; pointer-events: none; }
        }

        .loading-content {
            text-align: center;
            max-width: 600px;
            padding: 40px;
            position: relative;
        }

        .loading-title {
            font-size: 3.5rem;
            font-weight: 900;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #fff, #a78bfa, #06b6d4, #10b981, #f59e0b);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease-in-out infinite;
            text-shadow: 0 0 50px rgba(255, 255, 255, 0.3);
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .loading-subtitle {
            font-size: 1.5rem;
            margin-bottom: 50px;
            opacity: 0.9;
            animation: pulse 2s ease-in-out infinite;
        }

        .roulette-container {
            position: relative;
            width: 250px;
            height: 250px;
            margin: 0 auto 40px;
        }

        .roulette-wheel {
            width: 100%;
            height: 100%;
            border: 8px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            position: relative;
            background: conic-gradient(
                from 0deg,
                #ff6b6b 0deg 30deg,
                #4ecdc4 30deg 60deg,
                #45b7d1 60deg 90deg,
                #96ceb4 90deg 120deg,
                #ffeaa7 120deg 150deg,
                #dda0dd 150deg 180deg,
                #98d8c8 180deg 210deg,
                #f7dc6f 210deg 240deg,
                #ff9f9b 240deg 270deg,
                #74b9ff 270deg 300deg,
                #fd79a8 300deg 330deg,
                #fdcb6e 330deg 360deg
            );
            animation: rouletteSpin 4s cubic-bezier(0.25, 0.1, 0.25, 1) infinite;
            box-shadow: 
                0 0 50px rgba(255, 255, 255, 0.4),
                inset 0 0 30px rgba(0, 0, 0, 0.2);
        }

        @keyframes rouletteSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(1440deg); }
        }

        .roulette-center {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, #fff, #e2e8f0);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.8);
            z-index: 2;
        }

        .roulette-pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 35px solid #fff;
            transform: translateX(-50%);
            filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.5));
            z-index: 3;
            animation: pointerBounce 2s ease-in-out infinite;
        }

        @keyframes pointerBounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-5px); }
        }

        .loading-progress {
            width: 100%;
            max-width: 450px;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 0 auto 30px;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #06b6d4, #10b981, #a78bfa, #f59e0b);
            background-size: 200% 100%;
            width: 0%;
            transition: width 0.8s cubic-bezier(0.25, 0.1, 0.25, 1);
            animation: progressShimmer 2s ease-in-out infinite;
            border-radius: 4px;
        }

        @keyframes progressShimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .loading-steps {
            font-size: 1.3rem;
            margin-bottom: 30px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .step {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.6s ease;
        }

        .step.active {
            opacity: 1;
            transform: translateY(0);
        }

        .countdown-container {
            margin-top: 30px;
        }

        .countdown {
            font-size: 5rem;
            font-weight: 900;
            margin: 20px 0;
            text-shadow: 0 0 40px rgba(255, 255, 255, 0.6);
            animation: countdownPulse 1s ease-in-out;
        }

        @keyframes countdownPulse {
            0% {
                transform: scale(0.7);
                opacity: 0;
            }
            50% {
                transform: scale(1.3);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .countdown-text {
            font-size: 1.8rem;
            margin-bottom: 20px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Floating particles */
        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
        }

        /* Winner reveal animations */
        .result-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            animation: resultReveal 1s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes resultReveal {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(50px);
            }
            50% {
                transform: scale(1.05) translateY(-10px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .result-card h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 20px;
            text-align: center;
            animation: titleGlow 2s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            0% { text-shadow: 0 0 5px rgba(16, 185, 129, 0.3); }
            100% { text-shadow: 0 0 20px rgba(16, 185, 129, 0.6); }
        }

        .wallet-list {
            list-style: none;
            padding: 0;
            margin: 0;
            counter-reset: wallet-counter;
            padding-left: 20px;
        }

        .wallet-item {
            background: white;
            padding: 16px 20px;
            margin-bottom: 12px;
            border-radius: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            word-break: break-all;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid #f1f5f9;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
            opacity: 0;
            transform: translateX(-30px);
        }

        .wallet-item.reveal {
            animation: walletReveal 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes walletReveal {
            0% {
                opacity: 0;
                transform: translateX(-30px);
            }
            60% {
                transform: translateX(10px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .wallet-item:hover {
            background: #f8fafc;
            transform: translateX(8px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .wallet-item::before {
            content: counter(wallet-counter);
            counter-increment: wallet-counter;
            position: absolute;
            left: -12px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #020817, #131C2F);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
        }

        .copy-all-button {
            width: 100%;
            padding: 12px 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            transform: translateY(20px);
            opacity: 0;
            animation: buttonReveal 1s ease 0.5s forwards;
        }

        @keyframes buttonReveal {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .copy-all-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .copy-all-button:hover::before {
            left: 100%;
        }

        .copy-all-button:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
        }

        .copy-all-button.copied {
            background: linear-gradient(135deg, #020817 0%, #131C2F 100%);
        }

        .error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 1px solid #fca5a5;
            color: #dc2626;
            padding: 20px;
            border-radius: 12px;
            font-weight: 500;
        }

        .success {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border: 1px solid #86efac;
            color: #16a34a;
            padding: 20px;
            border-radius: 12px;
            font-weight: 500;
            margin-bottom: 24px;
        }

        @media (max-width: 768px) {
            .loading-title { font-size: 2.5rem; }
            .loading-subtitle { font-size: 1.2rem; }
            .countdown { font-size: 3.5rem; }
            .roulette-container { width: 200px; height: 200px; }
        }

        @media (max-width: 640px) {
            .container {
                padding: 32px 24px;
                margin: 20px;
            }

            h1 {
                font-size: 2rem;
            }

            .subtitle {
                font-size: 1rem;
                margin-bottom: 32px;
            }

            .select-button {
                padding: 16px 24px;
                font-size: 1rem;
            }

            .wallet-item {
                font-size: 0.85rem;
                padding: 14px 16px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 12px;
            }

            .container {
                padding: 24px 20px;
            }

            h1 {
                font-size: 1.8rem;
            }

            .wallet-list {
                padding-left: 16px;
            }

            .wallet-item::before {
                width: 24px;
                height: 24px;
                font-size: 0.7rem;
                left: -10px;
            }

            .loading-title { font-size: 2rem; }
            .countdown { font-size: 2.5rem; }
        }
    </style>
</head>
<body>
    <!-- DRAMATIC LOADING OVERLAY -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="particles" id="particles"></div>
        <div class="loading-content">
            <div class="loading-title">üé∞ SMART RAFFLE üé∞</div>
            <div class="loading-subtitle">Preparing to select your winners...</div>
            
            <div class="roulette-container">
                <div class="roulette-wheel"></div>
                <div class="roulette-center"></div>
                <div class="roulette-pointer"></div>
            </div>
            
            <div class="loading-progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <div class="loading-steps" id="loadingSteps">
                <div class="step">üîó Connecting to blockchain...</div>
            </div>
            
            <div class="countdown-container" id="countdownContainer" style="display: none;">
                <div class="countdown-text">Revealing Winners In</div>
                <div id="countdown" class="countdown"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>Smart Raffle</h1>
        <p class="subtitle">Randomly select winners for Faucet drop Droplist campaign<br><small style="opacity: 0.7; font-size: 0.9rem;">üí° Click any wallet address to copy</small></p>
        
        <div class="form-group">
            <label for="numWinners">Number of winners</label>
            <div class="input-container">
                <input type="number" id="numWinners" value="5" min="1" max="100">
            </div>
        </div>
        
        <button class="select-button" onclick="debouncedSelectRandomWallets()">Select Winners</button>
        
        <div id="result"></div>
    </div>

    <script>
        const DROPLIST_CONTRACT_ADDRESS = "0xB8De8f37B263324C44FD4874a7FB7A0C59D8C58E";
        const CHECKIN_ABI = [
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "address", "name": "user", "type": "address" },
                    { "indexed": false, "internalType": "uint256", "name": "timestamp", "type": "uint256" },
                    { "indexed": false, "internalType": "uint256", "name": "balance", "type": "uint256" }
                ],
                "name": "CheckIn",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "address", "name": "user", "type": "address" },
                    { "indexed": false, "internalType": "uint256", "name": "participantCount", "type": "uint256" }
                ],
                "name": "NewParticipant",
                "type": "event"
            },
            {
                "inputs": [
                    { "internalType": "address", "name": "user", "type": "address" }
                ],
                "name": "addressToString",
                "outputs": [
                    { "internalType": "string", "name": "", "type": "string" }
                ],
                "stateMutability": "pure",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "droplist",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getAllParticipants",
                "outputs": [
                    { "internalType": "address[]", "name": "", "type": "address[]" }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    { "internalType": "address", "name": "user", "type": "address" }
                ],
                "name": "getBalance",
                "outputs": [
                    { "internalType": "uint256", "name": "", "type": "uint256" }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    { "internalType": "uint256", "name": "index", "type": "uint256" }
                ],
                "name": "getParticipant",
                "outputs": [
                    { "internalType": "address", "name": "", "type": "address" }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getTotalTransactions",
                "outputs": [
                    { "internalType": "uint256", "name": "", "type": "uint256" }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getUniqueParticipantCount",
                "outputs": [
                    { "internalType": "uint256", "name": "", "type": "uint256" }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    { "internalType": "address", "name": "user", "type": "address" }
                ],
                "name": "hasAddressParticipated",
                "outputs": [
                    { "internalType": "bool", "name": "", "type": "bool" }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // Loading steps configuration
        const loadingSteps = [
            "üîó Connecting to blockchain...",
            "üîç Fetching all participants...",
            "‚ö° Validating smart contract...",
            "üé≤ Shuffling participants...",
            "‚ú® Selecting random winners...",
            "üéØ Finalizing results..."
        ];

        let currentStep = 0;
        let progressInterval;
        let stepInterval;

        // Create floating particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 4 + 's';
                particle.style.animationDuration = (Math.random() * 3 + 2) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Show dramatic loading
        function showDramaticLoading() {
            const overlay = document.getElementById('loadingOverlay');
            const progressBar = document.getElementById('progressBar');
            const stepsElement = document.getElementById('loadingSteps');
            
            overlay.classList.add('active');
            createParticles();
            
            currentStep = 0;
            let progress = 0;
            
            // Update loading steps
            stepInterval = setInterval(() => {
                // Hide current step
                const currentStepElement = stepsElement.querySelector('.step.active');
                if (currentStepElement) {
                    currentStepElement.classList.remove('active');
                }
                
                // Show next step
                if (currentStep < loadingSteps.length) {
                    stepsElement.innerHTML = `<div class="step active">${loadingSteps[currentStep]}</div>`;
                    currentStep++;
                } else {
                    clearInterval(stepInterval);
                }
            }, 1200);
            
            // Update progress bar
            progressInterval = setInterval(() => {
                progress += Math.random() * 15 + 5;
                if (progress > 100) progress = 100;
                progressBar.style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    startCountdown();
                }
            }, 800);
        }

        // Start countdown before revealing winners
        function startCountdown() {
            const stepsElement = document.getElementById('loadingSteps');
            const countdownContainer = document.getElementById('countdownContainer');
            const countdownElement = document.getElementById('countdown');
            
            // Hide steps, show countdown
            stepsElement.style.display = 'none';
            countdownContainer.style.display = 'block';
            
            let count = 3;
            countdownElement.textContent = count;
            
            const countInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownElement.textContent = count;
                    // Reset animation
                    countdownElement.style.animation = 'none';
                    setTimeout(() => {
                        countdownElement.style.animation = 'countdownPulse 1s ease-in-out';
                    }, 10);
                } else {
                    clearInterval(countInterval);
                    hideDramaticLoading();
                }
            }, 1000);
        }

        // Hide dramatic loading
        function hideDramaticLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('fade-out');
            
            setTimeout(() => {
                overlay.classList.remove('active', 'fade-out');
                overlay.style.display = 'none';
                
                // Reset for next time
                document.getElementById('progressBar').style.width = '0%';
                document.getElementById('loadingSteps').style.display = 'block';
                document.getElementById('countdownContainer').style.display = 'none';
                document.getElementById('particles').innerHTML = '';
            }, 1000);
        }

        // Debounce function to prevent multiple rapid clicks
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Retry mechanism for contract calls
        async function withRetry(fn, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (error.message.includes('circuit breaker is open') && i < retries - 1) {
                        console.warn(`Circuit breaker error, retrying (${i + 1}/${retries})...`);
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                        continue;
                    }
                    throw error;
                }
            }
        }

        async function switchNetwork() {
            const chainId = '0xa4ec'; // 42220 in hexadecimal for Celo Mainnet
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId }],
                });
                return true;
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [
                                {
                                    chainId: chainId,
                                    chainName: 'Celo Mainnet',
                                    nativeCurrency: {
                                        name: 'CELO',
                                        symbol: 'CELO',
                                        decimals: 18,
                                    },
                                    rpcUrls: ['https://forno.celo.org'],
                                    blockExplorerUrls: ['https://explorer.celo.org'],
                                },
                            ],
                        });
                        return true;
                    } catch (addError) {
                        console.error('Failed to add Celo network:', addError);
                        return false;
                    }
                }
                console.error('Failed to switch network:', switchError);
                return false;
            }
        }

        async function selectRandomWallets() {
            const numWinners = parseInt(document.getElementById('numWinners').value);
            const resultDiv = document.getElementById('result');
            const button = document.querySelector('.select-button');

            // Input validation
            if (isNaN(numWinners) || numWinners < 1 || numWinners > 100) {
                resultDiv.innerHTML = `
                    <div class="error">
                        Please enter a valid number of winners (1-100).
                    </div>
                `;
                resultDiv.style.display = 'block';
                resetButton(button);
                return;
            }

            // Show dramatic loading
            button.disabled = true;
            button.textContent = 'Selecting Wallets...';
            showDramaticLoading();

            // Initialize Web3
            let web3;
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                } catch (error) {
                    hideDramaticLoading();
                    resultDiv.innerHTML = `
                        <div class="error">
                            Failed to connect to MetaMask. Please ensure MetaMask is installed and unlocked.
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                    resetButton(button);
                    return;
                }
            } else {
                web3 = new Web3('https://forno.celo.org');
            }

            try {
                // Check network
                const networkId = await web3.eth.net.getId();
                const expectedNetworkId = 42220; // Celo Mainnet
                if (networkId !== expectedNetworkId && window.ethereum) {
                    const switched = await switchNetwork();
                    if (!switched) {
                        hideDramaticLoading();
                        resultDiv.innerHTML = `
                            <div class="error">
                                Failed to switch to Celo Mainnet (Network ID: ${expectedNetworkId}). Please switch manually in MetaMask.
                            </div>
                        `;
                        resultDiv.style.display = 'block';
                        resetButton(button);
                        return;
                    }
                }

                // Initialize contract
                const contract = new web3.eth.Contract(CHECKIN_ABI, DROPLIST_CONTRACT_ADDRESS);

                // Call getAllParticipants with retry
                const participants = await withRetry(() => contract.methods.getAllParticipants().call(), 3, 1000);

                if (!participants || participants.length === 0) {
                    hideDramaticLoading();
                    resultDiv.innerHTML = `
                        <div class="error">
                            No participants found in the contract.
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                    resetButton(button);
                    return;
                }

                if (numWinners > participants.length) {
                    hideDramaticLoading();
                    resultDiv.innerHTML = `
                        <div class="error">
                            Cannot select ${numWinners} wallets. Only ${participants.length} participants available.
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                    resetButton(button);
                    return;
                }

                // Wait for dramatic loading to complete (about 8-9 seconds total)
                setTimeout(() => {
                    // Fisher-Yates shuffle algorithm
                    const shuffled = [...participants];
                    for (let i = shuffled.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                    }

                    // Select winners
                    const selectedWallets = shuffled.slice(0, numWinners);

                    // Display results with animation
                    resultDiv.innerHTML = `
                        <div class="result-card">
                            <h3>üéâ Selected Winners</h3>
                            <button class="copy-all-button" onclick="copyAllWallets()">
                                üìã Copy All Wallet Addresses
                            </button>
                            <ul class="wallet-list">
                                ${selectedWallets.map(wallet => `<li class="wallet-item" title="Click to copy">${wallet}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                    resultDiv.style.display = 'block';

                    // Animate wallet items one by one
                    const walletItems = document.querySelectorAll('.wallet-item');
                    walletItems.forEach((item, index) => {
                        setTimeout(() => {
                            item.classList.add('reveal');
                        }, index * 150);
                    });

                    // Add click to copy functionality
                    walletItems.forEach(item => {
                        item.addEventListener('click', () => {
                            navigator.clipboard.writeText(item.textContent).then(() => {
                                const originalText = item.textContent;
                                item.textContent = 'Copied!';
                                item.style.background = '#dcfce7';
                                setTimeout(() => {
                                    item.textContent = originalText;
                                    item.style.background = '';
                                }, 1000);
                            });
                        });
                    });

                    resetButton(button);
                }, 9000); // Wait for full dramatic sequence

            } catch (error) {
                console.error('Contract interaction error:', error);
                hideDramaticLoading();
                let errorMessage = error.message;
                if (error.message.includes('circuit breaker is open')) {
                    errorMessage = 'MetaMask circuit breaker is open. Please try again in a few minutes, reset MetaMask, or switch to a different RPC provider.';
                }
                resultDiv.innerHTML = `
                    <div class="error">
                        Error: ${errorMessage}.<br>Please check the contract address, ABI, network connection, or try again later.
                    </div>
                `;
                resultDiv.style.display = 'block';
                resetButton(button);
            }
        }

        // Debounced version of selectRandomWallets
        const debouncedSelectRandomWallets = debounce(selectRandomWallets, 1000);

        function resetButton(button) {
            button.disabled = false;
            button.textContent = 'Select Winners';
        }

        function copyAllWallets() {
            const walletItems = document.querySelectorAll('.wallet-item');
            const addresses = Array.from(walletItems).map(item => item.textContent);
            const allAddresses = addresses.join('\n');
            
            navigator.clipboard.writeText(allAddresses).then(() => {
                const copyButton = document.querySelector('.copy-all-button');
                const originalText = copyButton.innerHTML;
                copyButton.innerHTML = '‚úÖ All Addresses Copied!';
                copyButton.classList.add('copied');
                
                setTimeout(() => {
                    copyButton.innerHTML = originalText;
                    copyButton.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy addresses: ', err);
                const textArea = document.createElement('textarea');
                textArea.value = allAddresses;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                const copyButton = document.querySelector('.copy-all-button');
                const originalText = copyButton.innerHTML;
                copyButton.innerHTML = '‚úÖ All Addresses Copied!';
                copyButton.classList.add('copied');
                
                setTimeout(() => {
                    copyButton.innerHTML = originalText;
                    copyButton.classList.remove('copied');
                }, 2000);
            });
        }
    </script>
</body>
</html>
